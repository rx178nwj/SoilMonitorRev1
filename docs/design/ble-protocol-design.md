# **BLEプロトコル設計**

## **1\. 目的**

本ドキュメントは、ESP32-C3植物監視システムのBLE通信における、より詳細なプロトコル、データフロー、および動作シーケンスを定義することを目的とします。これは、[BLE通信仕様](https://www.google.com/search?q=requirements/ble-communication-spec.md)を基に、実装レベルでの指針を提供します。

## **2\. 役割定義**

* **ペリフェラル (GATTサーバー):** ESP32-C3デバイス。センサーデータを収集し、セントラルからの接続を待ち受け、要求に応じてデータを提供・コマンドを実行します。  
* **セントラル (GATTクライアント):** スマートフォンアプリやPCアプリケーション。ペリフェラルに接続し、データの読み取り、通知の購読、コマンドの送信を行います。

## **3\. アドバタイジング仕様**

デバイスが自身を発見させるためのアドバタイジング（広告）パケットの仕様です。

* **アドバタイズタイプ:** 接続可能・スキャン可能なアドバタイズ (ADV\_IND)  
* **アドバタイズ間隔:**  
  * 通常時: 500 ms  
  * 高速接続モード時（将来的な拡張）: 100 ms  
* **アドバタイズパケット内容:**  
  * **Flags:** General Discoverable Mode, BR/EDR Not Supported  
  * **Complete Local Name:** "SoilMonitorV1"  
  * **Tx Power Level:** 送信電力レベル  
* **スキャンレスポンス内容:**  
  * **Complete List of 128-bit Service UUIDs:** 59462f12-9543-9999-12c8-58b459a2712d

## **4\. 接続とセキュリティ**

* **接続手順:**  
  1. セントラルはアドバタイズパケットをスキャンし、デバイス名またはサービスUUIDでターゲットデバイスを特定します。  
  2. セントラルは接続要求を送信し、ペリフェラルはこれを受理して接続を確立します。  
* **セキュリティ:**  
  * 初期バージョンではペアリングやボンディングは必須とせず、暗号化なしのオープンな接続を許可します。  
  * 将来的な拡張として、LE Secure Connectionsを用いたペアリングの導入を検討します。  
* **接続パラメータ:**  
  * **Connection Interval:** 100 ms (省電力と応答性のバランス)  
  * **Slave Latency:** 2  
  * **Supervision Timeout:** 4 s

## **5\. GATTサービス詳細**

サービスの全体像は[BLE通信仕様](https://www.google.com/search?q=requirements/ble-communication-spec.md)で定義されています。ここでは各キャラクタリスティックの動作について詳述します。

* **Sensor Data (Notify):**  
  * クライアントが通知を有効化すると、ペリフェラルは1分ごとに収集した最新のセンサーデータをsoil\_ble\_data\_t形式で送信します。  
* **Data Status (Read/Write):**  
  * **Read:** クライアントが読み取ると、デバイス内のデータバッファの統計情報（データ数、容量など）を返します。  
  * **Write:** 特定のコマンド（例: 履歴データの削除要求）を受け付けるために使用します。  
* **Command (Write):**  
  * クライアントは各種操作（データ取得、設定変更など）を行うために、このキャラクタリスティックにble\_command\_packet\_tを書き込みます。  
* **Response (Notify):**  
  * クライアントが通知を有効化している場合、デバイスはCommandキャラクタリスティックへの書き込みに対する結果をble\_response\_packet\_t形式で非同期に通知します。  
* **Data Transfer (Read/Write/Notify):**  
  * 履歴データのような大きなデータを転送するために使用します。MTUサイズに基づいたパケット分割と再構築のロジックがクライアントとデバイス双方で必要となります。（詳細は別途定義）

## **6\. 通信シーケンス**

### **6.1. コマンド・レスポンスフロー**

**正常系シーケンス:**

1. **クライアント:** **Response**キャラクタリスティックの通知を有効化（Subscribe）します。  
2. **クライアント:** **Command**キャラクタリスティックにコマンドパケット（例: CMD\_GET\_DEVICE\_INFO）を書き込みます。  
3. **デバイス:** コマンドを受信し、非同期で処理を開始します。  
4. **デバイス:** コマンド処理が完了すると、**Response**キャラクタリスティックを通じて結果を含むレスポンスパケットをクライアントに通知（Notify）します。  
5. **クライアント:** レスポンスパケットを受信し、シーケンス番号（sequence\_num）を照合してどのコマンドに対する応答かを確認します。

**異常系（デバイスビジー）:**

1. **クライアント:** コマンドAを書き込みます。  
2. **デバイス:** コマンドAの処理を開始します。  
3. **クライアント:** コマンドAの応答を待たずにコマンドBを書き込みます。  
4. **デバイス:** ビジー状態のため、コマンドBを破棄します。（この時点では応答を返さない）  
5. **デバイス:** コマンドAの処理が完了し、その応答を通知します。

### **6.2. センサーデータ自動更新フロー**

1. **クライアント:** **Sensor Data**キャラクタリスティックの通知を有効化（Subscribe）します。  
2. **デバイス:** 1分ごとにタイマーが起動し、センサー測定タスクを実行します。  
3. **デバイス:** 測定が完了すると、通知が有効化されていることを確認し、**Sensor Data**キャラクタリスティックを通じて最新データをクライアントに通知（Notify）します。  
4. **クライアント:** 通知されたセンサーデータを受信し、UIを更新します。  
5. **クライアント:** 接続が不要になったら、通知を無効化（Unsubscribe）します。

## **7\. 省電力設計**

* **アドバタイズ:** 非接続時は適度なアドバタイズ間隔（500ms）を維持します。  
* **接続パラメータ:** 比較的長めの接続間隔（100ms）とスレーブレーテンシーを設定し、デバイスがスリープ状態に入れる機会を増やします。  
* **処理:** BLEイベントやタイマー割り込み駆動の設計とし、CPUがアイドル状態（Light Sleep）になる時間を最大化します。