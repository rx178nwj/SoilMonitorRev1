ESP32-C3 BLEæ¤ç‰©ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ  Command-Responseæ©Ÿèƒ½çµ±åˆãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
ã‚ãªãŸã¯ãƒ—ãƒ­ã®IoTãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼ã§ã™ã€‚
ESP32ã¨BLEã«ç²¾é€šã—ã¦ãŠã‚Šã€æ¨™æº–çš„ãªCommand-Responseãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè£…çµŒé¨“ãŒè±Šå¯Œã§ã™ã€‚æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ã¸ã®å½±éŸ¿ã‚’æœ€å°é™ã«æŠ‘ãˆãªãŒã‚‰ã€æ‹¡å¼µæ€§ã¨ä¿å®ˆæ€§ã‚’é‡è¦–ã—ãŸå®Ÿè£…ã‚’è¡Œã£ã¦ãã ã•ã„ã€‚
ä½œæ¥­æ¦‚è¦
æ—¢å­˜ã®ESP32-C3 BLEæ¤ç‰©ç›£è¦–ã‚·ã‚¹ãƒ†ãƒ ã®ble_manager.cã«ã€æ¨™æº–çš„ãªBLE Command-Responseã‚·ã‚¹ãƒ†ãƒ ã¨æŒ‡å®šæ™‚é–“ãƒ‡ãƒ¼ã‚¿å–å¾—æ©Ÿèƒ½ã‚’çµ±åˆã—ã¦ãã ã•ã„ã€‚
è¿½åŠ ã™ã‚‹æ©Ÿèƒ½æ¦‚è¦
1. æ–°ã—ã„BLE Characteristicï¼ˆ3ã¤ï¼‰

Command Characteristic (Writeå°‚ç”¨)

UUID: 6a3b2c1d-4e5f-6a7b-8c9d-e0f123456791
ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£: BLE_GATT_CHR_F_WRITE | BLE_GATT_CHR_F_WRITE_NO_RSP
æ©Ÿèƒ½: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‹ã‚‰ã‚³ãƒãƒ³ãƒ‰ã‚’å—ä¿¡


Response Characteristic (Read/Notify)

UUID: 6a3b2c1d-4e5f-6a7b-8c9d-e0f123456792
ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£: BLE_GATT_CHR_F_READ | BLE_GATT_CHR_F_NOTIFY
æ©Ÿèƒ½: ã‚³ãƒãƒ³ãƒ‰ã®å®Ÿè¡Œçµæœã‚’ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«é€šçŸ¥


Data Transfer Characteristic (Read/Write/Notify)

UUID: 6a3b2c1d-4e5f-6a7b-8c9d-e0f123456793
ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£: BLE_GATT_CHR_F_READ | BLE_GATT_CHR_F_WRITE | BLE_GATT_CHR_F_NOTIFY
æ©Ÿèƒ½: å¤§ããªãƒ‡ãƒ¼ã‚¿ï¼ˆå±¥æ­´ãƒ‡ãƒ¼ã‚¿ã€è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ãªã©ï¼‰ã®è»¢é€



2. ãƒ‡ãƒ¼ã‚¿æ§‹é€ å®šç¾©
c// ã‚³ãƒãƒ³ãƒ‰ãƒ‘ã‚±ãƒƒãƒˆ
typedef struct __attribute__((packed)) {
    uint8_t command_id;      // ã‚³ãƒãƒ³ãƒ‰è­˜åˆ¥å­
    uint8_t sequence_num;    // ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·
    uint16_t data_length;    // ãƒ‡ãƒ¼ã‚¿é•·
    uint8_t data[];          // ã‚³ãƒãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿
} ble_command_packet_t;

// ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‘ã‚±ãƒƒãƒˆ
typedef struct __attribute__((packed)) {
    uint8_t response_id;     // ãƒ¬ã‚¹ãƒãƒ³ã‚¹è­˜åˆ¥å­
    uint8_t status_code;     // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰
    uint8_t sequence_num;    // å¯¾å¿œã™ã‚‹ã‚·ãƒ¼ã‚±ãƒ³ã‚¹ç•ªå·
    uint16_t data_length;    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿é•·
    uint8_t data[];          // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿
} ble_response_packet_t;

// æ™‚é–“æŒ‡å®šãƒªã‚¯ã‚¨ã‚¹ãƒˆç”¨æ§‹é€ ä½“
typedef struct __attribute__((packed)) {
    struct tm requested_time; // è¦æ±‚ã™ã‚‹æ™‚é–“
} time_data_request_t;

// æ™‚é–“æŒ‡å®šãƒ‡ãƒ¼ã‚¿å–å¾—ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”¨æ§‹é€ ä½“
typedef struct __attribute__((packed)) {
    struct tm actual_time;    // å®Ÿéš›ã«è¦‹ã¤ã‹ã£ãŸãƒ‡ãƒ¼ã‚¿ã®æ™‚é–“
    float temperature;        // æ°—æ¸©
    float humidity;          // æ¹¿åº¦
    float lux;              // ç…§åº¦
    float soil_moisture;    // åœŸå£Œæ°´åˆ†
} time_data_response_t;

// ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±æ§‹é€ ä½“
typedef struct __attribute__((packed)) {
    char device_name[32];
    char firmware_version[16];
    char hardware_version[16];
    uint32_t uptime_seconds;
    uint32_t total_sensor_readings;
} device_info_t;
3. å®Ÿè£…ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰
ctypedef enum {
    CMD_GET_SENSOR_DATA = 0x01,     // æœ€æ–°ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—
    CMD_GET_SYSTEM_STATUS = 0x02,   // ã‚·ã‚¹ãƒ†ãƒ çŠ¶æ…‹å–å¾—ï¼ˆãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã€ç¨¼åƒæ™‚é–“ç­‰ï¼‰
    CMD_SET_THRESHOLD = 0x03,       // åœŸå£Œæ°´åˆ†ã—ãã„å€¤è¨­å®š
    CMD_GET_HISTORY_DATA = 0x04,    // å±¥æ­´ãƒ‡ãƒ¼ã‚¿å–å¾—
    CMD_SYSTEM_RESET = 0x05,        // ã‚·ã‚¹ãƒ†ãƒ ãƒªã‚»ãƒƒãƒˆ
    CMD_GET_DEVICE_INFO = 0x06,     // ãƒ‡ãƒã‚¤ã‚¹æƒ…å ±å–å¾—ï¼ˆåå‰ã€FWãƒãƒ¼ã‚¸ãƒ§ãƒ³ç­‰ï¼‰
    CMD_SET_TIME = 0x07,            // æ™‚åˆ»è¨­å®š
    CMD_GET_CONFIG = 0x08,          // è¨­å®šå–å¾—
    CMD_SET_CONFIG = 0x09,          // è¨­å®šå¤‰æ›´
    CMD_GET_TIME_DATA = 0x0A,       // æŒ‡å®šæ™‚é–“ãƒ‡ãƒ¼ã‚¿å–å¾— â˜…é‡è¦â˜…
} ble_command_id_t;
4. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
ctypedef enum {
    RESP_STATUS_SUCCESS = 0x00,
    RESP_STATUS_ERROR = 0x01,
    RESP_STATUS_INVALID_COMMAND = 0x02,
    RESP_STATUS_INVALID_PARAMETER = 0x03,
    RESP_STATUS_BUSY = 0x04,
    RESP_STATUS_NOT_SUPPORTED = 0x05,
} ble_response_status_t;
å®Ÿè£…è¦æ±‚
1. GATT Serviceå®šç¾©ã®æ‹¡å¼µ
æ—¢å­˜ã®ã‚µãƒ¼ãƒ“ã‚¹ã«3ã¤ã®æ–°ã—ã„characteristicã‚’è¿½åŠ ã—ã€gatt_svr_svcs[]é…åˆ—ã‚’æ›´æ–°ã—ã¦ãã ã•ã„ã€‚
2. Access Callbacké–¢æ•°ç¾¤
ä»¥ä¸‹ã®Callbacké–¢æ•°ã‚’å®Ÿè£…ï¼š

gatt_svr_access_command_cb(): Command Characteristicç”¨
gatt_svr_access_response_cb(): Response Characteristicç”¨
gatt_svr_access_data_transfer_cb(): Data Transfer Characteristicç”¨

3. ã‚³ãƒãƒ³ãƒ‰å‡¦ç†ã‚¨ãƒ³ã‚¸ãƒ³
ä»¥ä¸‹ã®é–¢æ•°ç¾¤ã‚’å®Ÿè£…ï¼š
c// ãƒ¡ã‚¤ãƒ³ã‚³ãƒãƒ³ãƒ‰å‡¦ç†
static esp_err_t process_ble_command(const ble_command_packet_t *cmd_packet, 
                                    uint8_t *response_buffer, size_t *response_length);

// å„ã‚³ãƒãƒ³ãƒ‰å‡¦ç†é–¢æ•°
static esp_err_t handle_get_sensor_data(uint8_t sequence_num, uint8_t *response_buffer, size_t *response_length);
static esp_err_t handle_get_system_status(uint8_t sequence_num, uint8_t *response_buffer, size_t *response_length);
static esp_err_t handle_set_threshold(const uint8_t *data, uint16_t data_length, uint8_t sequence_num, uint8_t *response_buffer, size_t *response_length);
static esp_err_t handle_get_device_info(uint8_t sequence_num, uint8_t *response_buffer, size_t *response_length);

// â˜…é‡è¦â˜… æŒ‡å®šæ™‚é–“ãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•°
static esp_err_t handle_get_time_data(const uint8_t *data, uint16_t data_length, 
                                     uint8_t sequence_num, uint8_t *response_buffer, 
                                     size_t *response_length);
4. æŒ‡å®šæ™‚é–“ãƒ‡ãƒ¼ã‚¿æ¤œç´¢æ©Ÿèƒ½
æ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯:

åˆ†å˜ä½ã§ã®æ™‚é–“åˆ¤å®š: ç§’ã¯ç„¡è¦–ã—ã€å¹´æœˆæ—¥æ™‚åˆ†ãŒä¸€è‡´ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢
æ¤œç´¢é †åº:

ã¾ãšdata_bufferã®1åˆ†ãƒ‡ãƒ¼ã‚¿ï¼ˆéå»24æ™‚é–“åˆ†ï¼‰ã‹ã‚‰æ¤œç´¢
è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯g_soil_fifoã‹ã‚‰æ¤œç´¢


ãƒ¬ã‚¹ãƒãƒ³ã‚¹:

ãƒ‡ãƒ¼ã‚¿ç™ºè¦‹æ™‚: RESP_STATUS_SUCCESS + time_data_response_t
ãƒ‡ãƒ¼ã‚¿ãªã—æ™‚: RESP_STATUS_ERROR + ãƒ‡ãƒ¼ã‚¿é•·0



å¿…è¦ãªè£œåŠ©é–¢æ•°:
c// åˆ†å˜ä½æ™‚é–“æ¯”è¼ƒï¼ˆç§’ã¯ç„¡è¦–ï¼‰
static bool compare_time_minute(const struct tm *time1, const struct tm *time2);

// æŒ‡å®šæ™‚é–“ãƒ‡ãƒ¼ã‚¿æ¤œç´¢
static esp_err_t find_data_by_time(const struct tm *target_time, time_data_response_t *result);

// ãƒ¬ã‚¹ãƒãƒ³ã‚¹é€šçŸ¥é€ä¿¡
static esp_err_t send_response_notification(const uint8_t *response_data, size_t response_length);
5. ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°

ãƒ‡ãƒ¼ã‚¿é•·ãƒã‚§ãƒƒã‚¯ã€ä¸æ­£ã‚³ãƒãƒ³ãƒ‰å¯¾å¿œ
ç«¶åˆçŠ¶æ…‹ã®å›é¿ï¼ˆg_command_processingãƒ•ãƒ©ã‚°ï¼‰
ãƒ¡ãƒ¢ãƒªä¸è¶³ã€é€šä¿¡ã‚¨ãƒ©ãƒ¼ã®é©åˆ‡ãªå‡¦ç†

6. çŠ¶æ…‹ç®¡ç†å¤‰æ•°
ä»¥ä¸‹ã®ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã‚’è¿½åŠ ï¼š
cstatic uint16_t g_command_handle = 0;
static uint16_t g_response_handle = 0;
static uint16_t g_data_transfer_handle = 0;
static uint8_t g_last_sequence_num = 0;
static bool g_command_processing = false;
static uint32_t g_system_uptime = 0;
static uint32_t g_total_sensor_readings = 0;
7. BLEã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†ã®æ‹¡å¼µ
gap_event_handler()ã®BLE_GAP_EVENT_SUBSCRIBEã‚±ãƒ¼ã‚¹ã‚’æ‹¡å¼µã—ã€æ–°ã—ã„characteristicã®è³¼èª­çŠ¶æ…‹ã‚’ç®¡ç†ã—ã¦ãã ã•ã„ã€‚
8. ä¾å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®æ‹¡å¼µ
soil_data_fifo.h/.cã«ä»¥ä¸‹ã®é–¢æ•°ã‚’è¿½åŠ ï¼š
cesp_err_t soil_fifo_peek(const soil_fifo_t *fifo, size_t index, soil_data_t *data);
å®Ÿè£…ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³
ã‚³ãƒ¼ãƒ‰å“è³ªè¦æ±‚

å®‰å…¨æ€§: å…¨ã¦ã®ãƒã‚¤ãƒ³ã‚¿ã‚’nullãƒã‚§ãƒƒã‚¯ã€ãƒãƒƒãƒ•ã‚¡ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã‚’é˜²æ­¢
åŠ¹ç‡æ€§: ä¸è¦ãªãƒ¡ãƒ¢ãƒªã‚³ãƒ”ãƒ¼ã‚’é¿ã‘ã€è¨ˆç®—é‡ã‚’æœ€å°åŒ–
å¯èª­æ€§: é–¢æ•°åã€å¤‰æ•°åã¯è‡ªå·±èª¬æ˜çš„ã«ã€é©åˆ‡ãªã‚³ãƒ¡ãƒ³ãƒˆã‚’ä»˜ä¸
æ‹¡å¼µæ€§: æ–°ã—ã„ã‚³ãƒãƒ³ãƒ‰ã®è¿½åŠ ãŒå®¹æ˜“ãªæ§‹é€ 

ãƒ­ã‚°å‡ºåŠ›è¦å‰‡

INFO: æ­£å¸¸ãªå‡¦ç†ãƒ•ãƒ­ãƒ¼ï¼ˆã‚³ãƒãƒ³ãƒ‰å—ä¿¡ã€å‡¦ç†å®Œäº†ï¼‰
WARN: äºˆæœŸã—ãªã„ãŒå‡¦ç†å¯èƒ½ãªçŠ¶æ³ï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ç­‰ï¼‰
ERROR: ã‚¨ãƒ©ãƒ¼çŠ¶æ³ï¼ˆä¸æ­£ãªãƒ‡ãƒ¼ã‚¿ã€å‡¦ç†å¤±æ•—ç­‰ï¼‰

è¨­è¨ˆæ–¹é‡

æ—¢å­˜æ©Ÿèƒ½ã¸ã®å½±éŸ¿ã‚’æœ€å°é™ã«æŠ‘åˆ¶
æ‹¡å¼µæ€§ã‚’è€ƒæ…®ã—ãŸæ§‹é€ ï¼ˆæ–°ã‚³ãƒãƒ³ãƒ‰è¿½åŠ ãŒå®¹æ˜“ï¼‰
ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ã®å……å®Ÿ
ãƒ¡ãƒ¢ãƒªåŠ¹ç‡çš„ãªå®Ÿè£…
BLEæ¨™æº–çš„ãªå®Ÿè£…ãƒ‘ã‚¿ãƒ¼ãƒ³ã«æº–æ‹ 
åˆ†å˜ä½ã§ã®æ­£ç¢ºãªæ™‚é–“æ¤œç´¢

åˆæœŸåŒ–ãƒ­ã‚°ã®æ‹¡å¼µ
app_main()ã®æœ€å¾Œã«ä»¥ä¸‹ã®ãƒ­ã‚°ã‚’è¿½åŠ ï¼š
cESP_LOGI(TAG, "âœ… BLE Command-Response System initialized");
ESP_LOGI(TAG, "ğŸ“¡ Available commands:");
ESP_LOGI(TAG, "  - 0x01: Get Sensor Data");
ESP_LOGI(TAG, "  - 0x02: Get System Status");
ESP_LOGI(TAG, "  - 0x03: Set Threshold");
ESP_LOGI(TAG, "  - 0x06: Get Device Info");
ESP_LOGI(TAG, "  - 0x0A: Get Time-Specific Data");
ESP_LOGI(TAG, "ğŸ“¡ BLE Characteristics:");
ESP_LOGI(TAG, "  - Command: Write commands to device");
ESP_LOGI(TAG, "  - Response: Read/Notify for command responses");
ESP_LOGI(TAG, "  - Data Transfer: Read/Write/Notify for large data");
ä½¿ç”¨ä¾‹
ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆãŒã€Œ2024å¹´12æœˆ15æ—¥ 14:30ã€ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¦æ±‚ã™ã‚‹å ´åˆ:

time_data_request_tæ§‹é€ ä½“ã«æ™‚é–“ã‚’è¨­å®š
CMD_GET_TIME_DATAã‚³ãƒãƒ³ãƒ‰ã§é€ä¿¡
ã‚·ã‚¹ãƒ†ãƒ ã¯åˆ†å˜ä½ã§ä¸€è‡´ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢
è¦‹ã¤ã‹ã‚Œã°time_data_response_tã§å¿œç­”ã€ãªã‘ã‚Œã°ã‚¨ãƒ©ãƒ¼å¿œç­”

ã“ã®Command-Responseã‚·ã‚¹ãƒ†ãƒ ã«ã‚ˆã‚Šã€BLEçµŒç”±ã§ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ¶å¾¡ãƒ»ç›£è¦–ãƒ»å±¥æ­´ãƒ‡ãƒ¼ã‚¿æ¤œç´¢ãŒå¯èƒ½ã«ãªã‚Šã¾ã™ã€‚æ—¢å­˜ã®ã‚»ãƒ³ã‚µãƒ¼ãƒ‡ãƒ¼ã‚¿å–å¾—æ©Ÿèƒ½ã¯ç¶­æŒã—ã¤ã¤ã€ãƒ—ãƒ­ã®IoTã‚·ã‚¹ãƒ†ãƒ ã¨ã—ã¦é«˜åº¦ãªåˆ¶å¾¡æ©Ÿèƒ½ã‚’æä¾›ã—ã¦ãã ã•ã„ã€‚